@{
    ViewData["Title"] = "B√°o c√°o th·ªëng k√™";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fa fa-chart-bar me-2 text-primary"></i>
            B√°o c√°o th·ªëng k√™ & Bi·ªÉu ƒë·ªì
        </h2>
        <div>
            <a href="@Url.Action("Index", "Admin")" class="btn btn-outline-secondary me-2">
                <i class="fa fa-arrow-left me-1"></i>Quay l·∫°i
            </a>
            <button id="btnRefresh" class="btn btn-primary">
                <i class="fa fa-sync me-1"></i>L√†m m·ªõi
            </button>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fa fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form ch·ªçn kho·∫£ng th·ªùi gian -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fa fa-calendar me-2"></i>Ch·ªçn kho·∫£ng th·ªùi gian
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">T·ª´ ng√†y:</label>
                    <input type="date" id="fromDate" class="form-control" 
                           value="@ViewBag.FromDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="toDate" class="form-control" 
                           value="@ViewBag.ToDate" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="btnLoadData" class="btn btn-primary w-100">
                        <i class="fa fa-chart-line me-1"></i>T·∫£i d·ªØ li·ªáu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">ƒêang t·∫£i...</span>
        </div>
        <p class="mt-3 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- T·ªïng quan -->
    <div id="overviewSection" style="display: none;">
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fa fa-calendar-check fa-2x mb-2"></i>
                        <h3 class="fw-bold mb-0" id="totalBookings">0</h3>
                        <p class="mb-0 small">T·ªïng s·ªë booking</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <i class="fa fa-dollar-sign fa-2x mb-2"></i>
                        <h3 class="fw-bold mb-0" id="totalRevenue">0</h3>
                        <p class="mb-0 small">T·ªïng doanh thu</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="fa fa-users fa-2x mb-2"></i>
                        <h3 class="fw-bold mb-0" id="totalUsers">0</h3>
                        <p class="mb-0 small">S·ªë ng∆∞·ªùi d√πng</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white h-100">
                    <div class="card-body text-center">
                        <i class="fa fa-money-bill fa-2x mb-2"></i>
                        <h3 class="fw-bold mb-0" id="totalPayments">0</h3>
                        <p class="mb-0 small">S·ªë giao d·ªãch</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì -->
        <div class="row g-4 mb-4">
            <!-- Bi·ªÉu ƒë·ªì Booking & Doanh thu theo ng√†y -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fa fa-chart-line me-2 text-primary"></i>
                            Booking & Doanh thu theo ng√†y
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì tr·∫°ng th√°i Booking -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fa fa-pie-chart me-2 text-success"></i>
                            Tr·∫°ng th√°i Booking
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì Top tr·∫°m -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fa fa-charging-station me-2 text-info"></i>
                    Top 10 tr·∫°m s·∫°c c√≥ nhi·ªÅu booking nh·∫•t
                </h5>
            </div>
            <div class="card-body">
                <canvas id="stationChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let dailyChart, statusChart, stationChart;

// ‚úÖ Load d·ªØ li·ªáu T·ª∞ ƒê·ªòNG khi trang load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Trang Reports ƒë√£ load, b·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu...');
    loadChartData();
});

// N√∫t t·∫£i d·ªØ li·ªáu
document.getElementById('btnLoadData').addEventListener('click', function() {
    loadChartData();
});

document.getElementById('btnRefresh').addEventListener('click', function() {
    loadChartData();
});

function loadChartData() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;

    if (!fromDate || !toDate) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th·ªùi gian!');
        return;
    }

    console.log('üîÑ ƒêang t·∫£i d·ªØ li·ªáu t·ª´', fromDate, 'ƒë·∫øn', toDate);

    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('overviewSection').style.display = 'none';

    fetch('@Url.Action("GetChartData", "Admin")?fromDate=' + fromDate + '&toDate=' + toDate)
        .then(response => {
            console.log('üì° Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', data);
            
            if (data.success) {
                updateOverview(data.overview);
                updateDailyChart(data.dailyStats);
                updateStatusChart(data.statusStats);
                updateStationChart(data.stationStats);
                
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('overviewSection').style.display = 'block';
                
                console.log('‚úÖ C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì th√†nh c√¥ng!');
            } else {
                alert('L·ªói: ' + data.message);
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('‚ùå L·ªói:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error);
            document.getElementById('loadingSpinner').style.display = 'none';
        });
}

function updateOverview(data) {
    document.getElementById('totalBookings').textContent = data.totalBookings;
    document.getElementById('totalRevenue').textContent = formatNumber(data.totalRevenue) + ' VNƒê';
    document.getElementById('totalUsers').textContent = data.totalUsers;
    document.getElementById('totalPayments').textContent = data.totalPayments;
}

function updateDailyChart(data) {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    if (dailyChart) {
        dailyChart.destroy();
    }

    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(x => x.date),
            datasets: [
                {
                    label: 'S·ªë booking',
                    data: data.map(x => x.bookings),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                },
                {
                    label: 'Doanh thu (VNƒê)',
                    data: data.map(x => x.revenue),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.datasetIndex === 1) {
                                label += formatNumber(context.parsed.y) + ' VNƒê';
                            } else {
                                label += context.parsed.y;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'S·ªë booking'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Doanh thu (VNƒê)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function updateStatusChart(data) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (statusChart) {
        statusChart.destroy();
    }

    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ch·ªù x√°c nh·∫≠n', 'ƒê√£ x√°c nh·∫≠n', 'ƒêang s·∫°c', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'],
            datasets: [{
                data: [data.pending, data.confirmed, data.checkedIn, data.completed, data.cancelled],
                backgroundColor: [
                    'rgb(255, 205, 86)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateStationChart(data) {
    const ctx = document.getElementById('stationChart').getContext('2d');
    
    if (stationChart) {
        stationChart.destroy();
    }

    stationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(x => x.stationName),
            datasets: [
                {
                    label: 'S·ªë booking',
                    data: data.map(x => x.bookings),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    yAxisID: 'y'
                },
                {
                    label: 'Doanh thu (VNƒê)',
                    data: data.map(x => x.revenue),
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.datasetIndex === 1) {
                                label += formatNumber(context.parsed.y) + ' VNƒê';
                            } else {
                                label += context.parsed.y;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'S·ªë booking'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Doanh thu (VNƒê)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
</script>
}