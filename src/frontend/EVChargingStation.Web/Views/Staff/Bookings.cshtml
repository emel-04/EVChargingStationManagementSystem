@model List<EVChargingStation.Web.Models.BookingDto>

@{
    ViewData["Title"] = "Qu·∫£n l√Ω Booking - Nh√¢n vi√™n";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
            <i class="fa fa-calendar-check me-2 text-success"></i>
            Qu·∫£n l√Ω ƒë·∫∑t ch·ªó
        </h3>
        <div>
            <a href="@Url.Action("Index", "Staff")" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left me-1"></i>V·ªÅ Dashboard
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fa fa-check-circle me-1"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fa fa-exclamation-triangle me-1"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Filter Section -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">L·ªçc theo tr·∫°ng th√°i</label>
                    <select id="filterStatus" class="form-select">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="0">Ch·ªù x√°c nh·∫≠n</option>
                        <option value="1">ƒê√£ x√°c nh·∫≠n</option>
                        <option value="2">ƒêang s·∫°c</option>
                        <option value="3">Ho√†n th√†nh</option>
                        <option value="4">ƒê√£ h·ªßy</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">T√¨m ki·∫øm</label>
                    <input type="text" id="searchBox" class="form-control" placeholder="M√£ booking, t√™n ng∆∞·ªùi d√πng...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" id="filterDateFrom" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" id="filterDateTo" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="bookingsTable">
                    <thead class="table-success">
                        <tr>
                            <th>M√£ Booking</th>
                            <th>Ng∆∞·ªùi d√πng</th>
                            <th>Tr·∫°m s·∫°c</th>
                            <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                            <th>Th·ªùi gian k·∫øt th√∫c</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thanh to√°n</th>
                            <th class="text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null || !Model.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-5">
                                    <i class="fa fa-inbox fa-4x mb-3 d-block"></i>
                                    <h5>Ch∆∞a c√≥ ƒë·∫∑t ch·ªó n√†o</h5>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var b in Model)
                            {
                                <tr>
                                    <td><strong class="text-success">@b.BookingNumber</strong></td>
                                    <td>
                                        <i class="fa fa-user me-1"></i>@b.UserName
                                    </td>
                                    <td>
                                        <i class="fa fa-charging-station me-1"></i>@b.StationName
                                    </td>
                                    <td>
                                        <i class="fa fa-calendar me-1"></i>
                                        @b.StartTime.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                    <td>
                                        <i class="fa fa-calendar-check me-1"></i>
                                        @(b.EndTime?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                                    </td>
                                    <td>
                                        @switch (b.Status)
                                        {
                                            case 0: <span class="badge bg-warning text-dark">Ch·ªù x√°c nh·∫≠n</span>; break;
                                            case 1: <span class="badge bg-info">ƒê√£ x√°c nh·∫≠n</span>; break;
                                            case 2: <span class="badge bg-primary">ƒêang s·∫°c</span>; break;
                                            case 3: <span class="badge bg-success">Ho√†n th√†nh</span>; break;
                                            case 4: <span class="badge bg-danger">ƒê√£ h·ªßy</span>; break;
                                        }
                                    </td>
                                    <td>
                                        @if (b.Status == 3 && !b.HasPayment)
                                        {
                                            <button class="btn btn-warning btn-sm" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#paymentModal" 
                                                    data-booking-id="@b.Id"
                                                    data-booking-number="@b.BookingNumber"
                                                    data-station-name="@b.StationName"
                                                    data-user-name="@b.UserName"
                                                    title="T·∫°o thanh to√°n">
                                                <i class="fa fa-dollar-sign me-1"></i>T·∫°o TT
                                            </button>
                                        }
                                        else if (b.HasPayment)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fa fa-check-circle"></i> ƒê√£ TT
                                            </span>
                                        }
                                        else if (b.Status == 3)
                                        {
                                            <span class="text-muted small">Ch∆∞a TT</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-success btn-sm"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editBookingModal"
                                                data-id="@b.Id" 
                                                data-status="@b.Status"
                                                title="Ch·ªânh s·ª≠a tr·∫°ng th√°i">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªânh s·ª≠a booking -->
<div class="modal fade" id="editBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/Staff/EditBooking">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editId" value="" />
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fa fa-edit me-2"></i>Ch·ªânh s·ª≠a tr·∫°ng th√°i
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select name="status" class="form-select" id="editStatus">
                            <option value="0">Ch·ªù x√°c nh·∫≠n</option>
                            <option value="1">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="2">ƒêang s·∫°c</option>
                            <option value="3">Ho√†n th√†nh</option>
                            <option value="4">ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-save me-1"></i>L∆∞u thay ƒë·ªïi
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal t·∫°o thanh to√°n -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="/Staff/CreatePayment">
                @Html.AntiForgeryToken()
                <input type="hidden" name="bookingId" id="paymentBookingId" />
                
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fa fa-dollar-sign me-2"></i>T·∫°o thanh to√°n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Th√¥ng tin booking -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fa fa-info-circle me-2"></i>Th√¥ng tin ƒë·∫∑t ch·ªó
                        </h6>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>M√£ booking:</strong> <span id="infoBookingNumber"></span></p>
                                <p class="mb-1"><strong>Kh√°ch h√†ng:</strong> <span id="infoUserName"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Tr·∫°m s·∫°c:</strong> <span id="infoStationName"></span></p>
                                <p class="mb-0"><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">Ho√†n th√†nh</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Form nh·∫≠p th√¥ng tin thanh to√°n -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fa fa-money-bill-wave me-1 text-success"></i>
                                S·ªë ti·ªÅn thanh to√°n (VNƒê) <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control form-control-lg" 
                                   name="amount" 
                                   id="paymentAmount"
                                   min="1000" 
                                   step="1000" 
                                   placeholder="Nh·∫≠p s·ªë ti·ªÅn"
                                   required />
                            <div class="form-text">S·ªë ti·ªÅn t·ªëi thi·ªÉu: 1.000 VNƒê</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fa fa-credit-card me-1 text-primary"></i>
                                Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span>
                            </label>
                            <select class="form-select form-select-lg" name="method" required>
                                <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
                                <option value="0">üíµ Ti·ªÅn m·∫∑t</option>
                                <option value="1">üí≥ Th·∫ª ng√¢n h√†ng</option>
                                <option value="2">üì± V√≠ ƒëi·ªán t·ª≠</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="fa fa-sticky-note me-1 text-warning"></i>
                                Ghi ch√∫ (t√πy ch·ªçn)
                            </label>
                            <textarea class="form-control" 
                                      name="description" 
                                      rows="2" 
                                      placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."></textarea>
                        </div>
                    </div>

                    <!-- T√≠nh to√°n t·∫°m th·ªùi -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-0 text-muted">T·ªïng ti·ªÅn:</p>
                            </div>
                            <div class="col-6 text-end">
                                <h5 class="mb-0 text-success" id="totalAmount">0 VNƒê</h5>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>H·ªßy
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fa fa-check-circle me-1"></i>T·∫°o thanh to√°n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Modal ch·ªânh s·ª≠a booking
    const editModal = document.getElementById("editBookingModal");
    editModal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        document.getElementById("editId").value = button.dataset.id;
        document.getElementById("editStatus").value = button.dataset.status;
    });

    // Modal t·∫°o thanh to√°n
    const paymentModal = document.getElementById("paymentModal");
    paymentModal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        
        // L·∫•y d·ªØ li·ªáu t·ª´ button
        const bookingId = button.dataset.bookingId;
        const bookingNumber = button.dataset.bookingNumber;
        const stationName = button.dataset.stationName;
        const userName = button.dataset.userName;
        
        // ƒêi·ªÅn th√¥ng tin v√†o modal
        document.getElementById("paymentBookingId").value = bookingId;
        document.getElementById("infoBookingNumber").textContent = bookingNumber;
        document.getElementById("infoStationName").textContent = stationName;
        document.getElementById("infoUserName").textContent = userName;
        
        // Reset form
        document.getElementById("paymentAmount").value = "";
        document.getElementById("totalAmount").textContent = "0 VNƒê";
    });

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi nh·∫≠p s·ªë ti·ªÅn
    const amountInput = document.getElementById("paymentAmount");
    amountInput.addEventListener("input", function() {
        const amount = parseFloat(this.value) || 0;
        const formatted = amount.toLocaleString('vi-VN') + ' VNƒê';
        document.getElementById("totalAmount").textContent = formatted;
    });

    // Filter functionality
    const filterStatus = document.getElementById("filterStatus");
    const searchBox = document.getElementById("searchBox");
    const filterDateFrom = document.getElementById("filterDateFrom");
    const filterDateTo = document.getElementById("filterDateTo");

    [filterStatus, searchBox, filterDateFrom, filterDateTo].forEach(elem => {
        elem.addEventListener("change", filterTable);
        elem.addEventListener("keyup", filterTable);
    });
});

function filterTable() {
    const statusFilter = document.getElementById("filterStatus").value;
    const searchText = document.getElementById("searchBox").value.toLowerCase();
    const rows = document.querySelectorAll("#bookingsTable tbody tr");
    
    rows.forEach(row => {
        if (row.cells.length === 1) return;

        const bookingNumber = row.cells[0].textContent.toLowerCase();
        const userName = row.cells[1].textContent.toLowerCase();
        const statusBadge = row.cells[5].querySelector(".badge");

        let showRow = true;

        if (statusFilter && statusBadge) {
            const rowStatus = statusBadge.textContent.trim();
            const filterMap = {
                "0": "Ch·ªù x√°c nh·∫≠n",
                "1": "ƒê√£ x√°c nh·∫≠n",
                "2": "ƒêang s·∫°c",
                "3": "Ho√†n th√†nh",
                "4": "ƒê√£ h·ªßy"
            };
            if (rowStatus !== filterMap[statusFilter]) {
                showRow = false;
            }
        }

        if (searchText && !bookingNumber.includes(searchText) && !userName.includes(searchText)) {
            showRow = false;
        }

        row.style.display = showRow ? "" : "none";
    });
}
</script>
}

<style>
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
tbody tr:hover {
    background-color: #f8f9fa;
}
.badge {
    font-size: 0.85rem;
    padding: 0.4em 0.8em;
}
.form-control-lg, .form-select-lg {
    font-size: 1.1rem;
}
</style>